name: Kind CI Workflow

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write # נדרש כדי לבצע 'git push'

jobs:
  deploy-to-kind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. הקמת Cluster של Kind
      # [FIX] החזרתי את השלב הזה. הוא יוצר Kind Cluster בתוך ה-Runner.
      # זה פותר את שגיאת ה-"connection refused"
      - name: Set up Kind Cluster
        uses: helm/kind-action@v1.9.0
        # פעולה זו מגדירה אוטומטית את kubectl
        # כך שהוא "מצביע" על ה-cluster החדש שנוצר

      # 2. יוצרים סיקרט ב-K8s מהסיקרט של GitHub
      - name: Create or Update Kubernetes Secret
        run: |
          # כאן אין צורך לציין --namespace כי Kind
          # בדרך כלל משתמש ב-default, אלא אם הגדרת אחרת
          kubectl create secret generic my-app-secret \
            --from-literal=username='${{ secrets.MY_USERNAME_SECRET }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      # 3. מריצים Helm
      - name: Deploy Helm Chart
        run: |
          # ודא שהנתיב ל-chart ('./myChart') נכון
          helm upgrade --install my-release ./myChart --wait
          # הוספתי --wait כדי שה-workflow יחכה שהפריסה תסתיים

      # 4. מגדירים את התג החדש
      - name: Define New Image Tag
        run: echo "NEW_TAG=v0.${{ github.run_number }}" >> $GITHUB_ENV

      # 5. מעדכנים את קובץ ה-values (הדרך הנכונה, עם 'sed')
      - name: Update values.yaml with new image tag
        run: |
          # ודא שהנתיב לקובץ (myChart/values-image.yaml) נכון
          sed -i 's|^\( *tag: *\).*|\1"${{ env.NEW_TAG }}"|' myChart/values-image.yaml
          
          echo "--- Updated values-image.yaml ---"
          cat mychar/values-image.yaml
          echo "---------------------------------"

      # 6. מבצעים Commit לקובץ המעודכן
      - name: Commit updated values.yaml
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git status
          
          # הוספה של הקובץ הספציפי ששינינו
          git add myChart/values-image.yaml
          
          # בודק אם באמת יש שינוי לפני שמנסה לעשות commit
          if ! git diff --staged --quiet; then
            git commit -m "Update image tag to ${{ env.NEW_TAG }} [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi